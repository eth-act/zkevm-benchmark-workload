name: Run Benchmark
on:
  workflow_call:
    inputs:
      tests:
        required: true
        type: string
        description: Space-separated list of tests to run
      zkvm:
        required: true
        type: string
        description: ZKVM to use
      el:
        required: false
        type: string
        default: ''
        description: Execution layer client
      threads:
        required: true
        type: number
        description: Number of threads for RAYON_NUM_THREADS

jobs:
  run-benchmark:
    name: ${{ inputs.zkvm }} / ${{ inputs.el }}
    runs-on: [self-hosted-ghr, size-chungus-x64]
    env:
      ERE_TAG: 0.0.15-a75f8f4
      OPENVM_RUST_TOOLCHAIN: nightly-2025-08-07
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.sccache/
      SCCACHE_CACHE_SIZE: 10G 
      CARGO_INCREMENTAL: "0"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler pkg-config libssl-dev sccache build-essential clang libclang-dev lz4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: jsign/action-cache@0aa95a6bc53b4dc5c7a53d773e183d8169ce2c01
        with:
          action: restore
          key: ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-${{ hashFiles('Cargo.lock') }}
          path: |
            ${{ github.workspace }}/.sccache/
            target
            ere-guests/target
          restore-keys: |
            ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-
            ${{ runner.os }}-cargo-
          cache-username: ${{ secrets.CACHE_USERNAME }}
          cache-password: ${{ secrets.CACHE_PASSWORD }}

      - name: Pull ere images
        run: |
          for variant in "base" "base-${{ inputs.zkvm }}" "compiler-${{ inputs.zkvm }}" "server-${{ inputs.zkvm }}"; do
            src="docker.ethquokkaops.io/gh/eth-act/ere/ere-${variant}:${ERE_TAG}"
            dst="ere-${variant}:${ERE_TAG}"
            docker pull "$src"
            docker tag "$src" "$dst"
          done

      - name: Run benchmark
        run: |
            RAYON_NUM_THREADS=${{ inputs.threads }} \
            RUST_LOG=warn,benchmark_runner=info \
            ZKVM=${{ inputs.zkvm }} \
            EL=${{ inputs.el }} \
            cargo test --release -p integration-tests -- --test-threads=1 ${{ inputs.tests }}
      
      - name: sccache stats
        run: sccache --show-stats || true

      - name: Save Rust cache
        uses: jsign/action-cache@0aa95a6bc53b4dc5c7a53d773e183d8169ce2c01
        with:
          action: save
          key: ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-${{ hashFiles('Cargo.lock') }}
          path: |
            ${{ github.workspace }}/.sccache/
            target
            ere-guests/target
          cache-username: ${{ secrets.CACHE_USERNAME }}
          cache-password: ${{ secrets.CACHE_PASSWORD }}