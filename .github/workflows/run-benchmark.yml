name: Run Benchmark
on:
  workflow_call:
    inputs:
      test:
        required: true
        type: string
        description: Test to run
      upload_results:
        required: false
        type: boolean
        default: false
        description: Whether to create and upload benchmark results
      zkvm:
        required: true
        type: string
        description: ZKVM to use
      el:
        required: false
        type: string
        default: ''
        description: Execution layer client
      threads:
        required: true
        type: number
        description: Number of threads for RAYON_NUM_THREADS

jobs:
  run-benchmark:
    name: ${{ inputs.zkvm }} - ${{ inputs.test }}
    runs-on: [self-hosted-ghr, size-xl-x64]
    env:
      ERE_TAG: 0.0.14-5264391
      OPENVM_RUST_TOOLCHAIN: nightly-2025-08-07
      RUSTC_WRAPPER: sccache
      SCCACHE_DIR: ${{ github.workspace }}/.sccache/
      SCCACHE_CACHE_SIZE: 10G 
      CARGO_INCREMENTAL: "0"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler pkg-config libssl-dev sccache build-essential clang libclang-dev nasm

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Restore Rust cache
        uses: EthDevOps/action-cache@846782e812a5f02b48f3317d7dee5bff3d9e34de
        with:
          action: restore
          key: ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-${{ hashFiles('Cargo.lock') }}
          path: |
            ${{ github.workspace }}/.sccache/
            target
            ere-guests/target
          restore-keys: |
            ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-
            ${{ runner.os }}-cargo-
          cache-username: ${{ secrets.CACHE_USERNAME }}
          cache-password: ${{ secrets.CACHE_PASSWORD }}

      - name: Pull ere images
        run: |
          for variant in "base" "base-${{ inputs.zkvm }}" "compiler-${{ inputs.zkvm }}" "server-${{ inputs.zkvm }}"; do
            src="ghcr.io/eth-act/ere/ere-${variant}:${ERE_TAG}"
            dst="ere-${variant}:${ERE_TAG}"
            docker pull "$src"
            docker tag "$src" "$dst"
          done

      - name: Run benchmark
        run: |
            RAYON_NUM_THREADS=${{ inputs.threads }} \
            RUST_LOG=warn,benchmark_runner=info \
            ZKVM=${{ inputs.zkvm }} \
            EL=${{ inputs.el }} \
            WORKLOAD_OUTPUT_DIR=./zkevm-metrics \
            cargo test --release -p integration-tests -- --test-threads=1 ${{ inputs.test }}
      
      - name: sccache stats
        run: sccache --show-stats || true

      - name: Create results archive
        if: ${{ inputs.upload_results }}
        run: |
          cd tests && tar -czvf benchmark-results.tar.gz ./zkevm-metrics

      - name: Upload benchmark results
        if: ${{ inputs.upload_results }}
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ inputs.el }}-${{ inputs.zkvm }}-${{ inputs.test }}
          path: tests/benchmark-results.tar.gz
          retention-days: 90
      
      - name: Save Rust cache
        if: always()
        uses: EthDevOps/action-cache@846782e812a5f02b48f3317d7dee5bff3d9e34de
        with:
          action: save
          key: ${{ runner.os }}-cargo-${{ inputs.zkvm }}-${{ inputs.el }}-${{ hashFiles('Cargo.lock') }}
          path: |
            ${{ github.workspace }}/.sccache/
            target
            ere-guests/target
          cache-username: ${{ secrets.CACHE_USERNAME }}
          cache-password: ${{ secrets.CACHE_PASSWORD }}