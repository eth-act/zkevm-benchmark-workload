# Docker Compose for SP1 Cluster using REMOTE images from GHCR
# No local build required - just pull and run!
#
# Usage:
#   docker compose -f docker-compose.yml down -v
#   docker compose -f docker-compose.yml up -d postgresql redis api coordinator cpu-node gpu0 gpu1 gpu2 gpu3
#   sleep 15
#
# Configuration:
#   Copy env.example to .env and customize resource limits and ports.
#   See env.example for all available configuration options.
#
# High Availability Notes:
#   This configuration runs a single instance of each service. For production
#   deployments requiring high availability:
#   
#   1. Run multiple SP1 clusters on separate machines with a load balancer
#   2. Use external managed services for Redis and PostgreSQL
#   3. Configure proper monitoring and alerting
#   4. Implement backup and recovery procedures
#
#   See the documentation for detailed HA deployment guidance.

services:
  # Redis service - Used for artifact storage and caching
  redis:
    image: bitnami/redis:latest
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redispassword}
      - REDIS_AOF_ENABLED=no
    volumes:
      - redis_data:/bitnami/redis/data
    ports:
      - "0.0.0.0:${REDIS_PORT:-6379}:6379"
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT:-30G}
        reservations:
          memory: ${REDIS_MEMORY_RESERVATION:-30G}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redispassword}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # PostgreSQL database - Stores cluster state and job metadata
  postgresql:
    image: bitnami/postgresql:latest
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgrespassword}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-postgres}
    volumes:
      - postgresql_data:/bitnami/postgresql
    # ports:
    #   - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # API Service - Main entry point for proof requests
  api:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - API_GRPC_ADDR=0.0.0.0:50051
      - API_HTTP_ADDR=0.0.0.0:3000
      - API_AUTO_MIGRATE=true
      - API_DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgrespassword}@postgresql:5432/${POSTGRES_DB:-postgres}
    ports:
      - "0.0.0.0:${API_PORT:-50051}:50051"
    depends_on:
      postgresql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50051 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # Coordinator Service - Manages job distribution to workers
  coordinator:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - COORDINATOR_CLUSTER_RPC=http://api:50051
      - COORDINATOR_METRICS_ADDR=0.0.0.0:9090
      - COORDINATOR_ADDR=0.0.0.0:50051
    command: ["/bin/sh", "-c", "/coordinator"]
    # ports:
    #   - "50052:50051"
    depends_on:
      api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 50051 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # CPU Node - Handles CPU-bound proving tasks
  cpu-node:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - NODE_COORDINATOR_RPC=http://coordinator:50051
      - WORKER_MAX_WEIGHT_OVERRIDE=32
      - NODE_ARTIFACT_STORE=redis
      - NODE_REDIS_NODES=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - WORKER_TYPE=CPU
    volumes:
      - ${SP1_CIRCUITS_DIR:-${HOME}/.sp1/circuits}:/root/.sp1/circuits
    command: ["/bin/sh", "-c", "/node"]
    deploy:
      resources:
        limits:
          cpus: '${CPU_NODE_CPUS_LIMIT:-8}'
          memory: ${CPU_NODE_MEMORY_LIMIT:-32G}
        reservations:
          cpus: '${CPU_NODE_CPUS_RESERVATION:-4}'
          memory: ${CPU_NODE_MEMORY_RESERVATION:-32G}
    depends_on:
      coordinator:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # CPU Node (mixed mode) - Handles both CPU and GPU tasks
  mixed:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - NODE_COORDINATOR_RPC=http://coordinator:50051
      - WORKER_MAX_WEIGHT_OVERRIDE=32
      - NODE_ARTIFACT_STORE=redis
      - NODE_REDIS_NODES=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - WORKER_TYPE=ALL
    volumes:
      - ${SP1_CIRCUITS_DIR:-${HOME}/.sp1/circuits}:/root/.sp1/circuits
    command: ["/bin/sh", "-c", "/node"]
    deploy:
      resources:
        limits:
          cpus: '${MIXED_NODE_CPUS_LIMIT:-8}'
          memory: ${MIXED_NODE_MEMORY_LIMIT:-32G}
        reservations:
          cpus: '${MIXED_NODE_CPUS_RESERVATION:-4}'
          memory: ${MIXED_NODE_MEMORY_RESERVATION:-32G}
    depends_on:
      coordinator:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # GPU Node - Base configuration for GPU-accelerated proving
  # Each GPU worker is assigned to a single GPU for isolation
  # Benefits: Memory isolation, fault tolerance, predictable performance
  gpu0:
    image: ghcr.io/succinctlabs/sp1-cluster:node-gpu-latest
    command: ["/bin/sh", "-c", "/app/sp1-cluster-node"]
    environment:
      - NODE_COORDINATOR_RPC=http://coordinator:50051
      - WORKER_MAX_WEIGHT_OVERRIDE=24
      - NODE_ARTIFACT_STORE=redis
      - NODE_REDIS_NODES=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - WORKER_TYPE=GPU
      - RUST_LOG=info,moongate_core=off
    volumes:
      - ${SP1_CIRCUITS_DIR:-${HOME}/.sp1/circuits}:/root/.sp1/circuits
    deploy:
      resources:
        limits:
          cpus: '${GPU_NODE_CPUS_LIMIT:-32}'
          memory: ${GPU_NODE_MEMORY_LIMIT:-24G}
        reservations:
          cpus: '${GPU_NODE_CPUS_RESERVATION:-32}'
          memory: ${GPU_NODE_MEMORY_RESERVATION:-24G}
    depends_on:
      coordinator:
        condition: service_healthy
      redis:
        condition: service_healthy
      cpu-node:
        condition: service_started
    # GPU support - requires NVIDIA Container Toolkit
    runtime: nvidia
    restart: unless-stopped

  gpu1:
    environment:
    - CUDA_VISIBLE_DEVICES=1
    extends:
      service: gpu0

  gpu2:
    environment:
    - CUDA_VISIBLE_DEVICES=2
    extends:
      service: gpu0

  gpu3:
    environment:
    - CUDA_VISIBLE_DEVICES=3
    extends:
      service: gpu0

  gpu4:
    environment:
    - CUDA_VISIBLE_DEVICES=4
    extends:
      service: gpu0

  gpu5:
    environment:
    - CUDA_VISIBLE_DEVICES=5
    extends:
      service: gpu0

  gpu6:
    environment:
    - CUDA_VISIBLE_DEVICES=6
    extends:
      service: gpu0

  gpu7:
    environment:
    - CUDA_VISIBLE_DEVICES=7
    extends:
      service: gpu0

  # Fulfiller Service - Handles proof fulfillment
  fulfiller:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - FULFILLER_CLUSTER_RPC=http://api:50051
      - FULFILLER_LOG_FORMAT=Pretty
      - FULFILLER_CLUSTER_ARTIFACT_STORE=redis
      - FULFILLER_VERSION=sp1-v5.0.0
      - FULFILLER_DOMAIN=SPN_SEPOLIA_V1_DOMAIN
      - FULFILLER_CLUSTER_REDIS_NODES=redis://:${REDIS_PASSWORD:-redispassword}@redis:6379/0
      - FULFILLER_METRICS_ADDR=0.0.0.0:9090
      - FULFILLER_RPC_GRPC_ADDR=${RPC_GRPC_ADDR}
      - FULFILLER_SP1_PRIVATE_KEY=8f59a842310388db9a785653312f501c16e6753979ba6ca5eb74d2e64acef1c7
    depends_on:
      coordinator:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: ["/bin/sh", "-c", "/fulfiller"]
    restart: unless-stopped

  # Bidder Service - Handles proof bidding
  bidder:
    image: ghcr.io/succinctlabs/sp1-cluster:base-latest
    environment:
      - BIDDER_LOG_FORMAT=Pretty
      - BIDDER_VERSION=sp1-v5.0.0
      - BIDDER_DOMAIN=SPN_SEPOLIA_V1_DOMAIN
      - BIDDER_METRICS_ADDR=0.0.0.0:9090
      - BIDDER_RPC_GRPC_ADDR=${RPC_GRPC_ADDR}
      - BIDDER_SP1_PRIVATE_KEY=8f59a842310388db9a785653312f501c16e6753979ba6ca5eb74d2e64acef1c7
      - BIDDER_THROUGHPUT_MGAS=1
      - BIDDER_MAX_CONCURRENT_PROOFS=1
      - BIDDER_BID_AMOUNT=1
    command: ["/bin/sh", "-c", "/bidder"]
    restart: unless-stopped

volumes:
  redis_data:
  postgresql_data:
